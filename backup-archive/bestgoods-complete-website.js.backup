/**
 * BestGoods 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è¿˜åŸçš„å®Œæ•´ç½‘ç«™
 * åˆå¹¶å¤‡ä»½ä¸­çš„é¦–é¡µå’Œè¯¦æƒ…é¡µï¼Œå…¨éƒ¨ä½¿ç”¨3076ç«¯å£
 * åŒ…å«ï¼šé¦–é¡µæœç´¢åŠŸèƒ½ã€è¯¦æƒ…é¡µè¡¨æ ¼æ•ˆæœã€è¯„é€‰ç»“æœè¯¦æƒ…ã€ç‚¹èµç‚¹è¸©ã€è¯„è®ºåŠŸèƒ½
 */

const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const app = express();
const PORT = process.env.PORT || 3076;

// ==========================================
// æ•°æ®åº“é…ç½®
// ==========================================
const dbPath = path.join(__dirname, 'data/bestgoods.db');
let db = null;

// åˆå§‹åŒ–æ•°æ®åº“
function initDatabase() {
  return new Promise((resolve, reject) => {
    console.log(`ğŸ” è¿æ¥æ•°æ®åº“: ${dbPath}`);
    db = new sqlite3.Database(dbPath, (err) => {
      if (err) {
        console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', err.message);
        console.error('æ•°æ®åº“è·¯å¾„:', dbPath);
        console.error('é”™è¯¯ä»£ç :', err.code);
        reject(err);
      } else {
        console.log('âœ… SQLiteæ•°æ®åº“è¿æ¥æˆåŠŸ');
        resolve(db);
      }
    });
  });
}

// æ•°æ®åº“æŸ¥è¯¢å‡½æ•°
function query(sql, params = []) {
  return new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
      if (err) {
        console.error('âŒ æŸ¥è¯¢é”™è¯¯:', err.message);
        console.error('SQLè¯­å¥:', sql);
        console.error('å‚æ•°:', params);
        reject(err);
      } else {
        resolve(rows);
      }
    });
  });
}

// ==========================================
// å†…å­˜å­˜å‚¨
// ==========================================
const memoryStorage = {
  votes: {}, // æ ¼å¼: { "product_1_1": { likes: 0, dislikes: 0, userVotes: {} } }
  comments: [] // æ ¼å¼: [{ user: 'åŒ¿åç”¨æˆ·', content: '...', time: '...', level1: '...', level2: '...', level3: '...' }]
};

// åˆå§‹åŒ–å†…å­˜æ•°æ®ï¼ˆæŠ•ç¥¨åˆå§‹å€¼ä¸º0ï¼Œè¯„è®ºåˆå§‹ä¸ºç©ºï¼‰
function initializeMemoryData() {
  // ä¸º9ä¸ªäº§å“åˆå§‹åŒ–æŠ•ç¥¨æ•°æ®ï¼ˆåˆå§‹å€¼ä¸º0ï¼‰
  for (let priceId = 1; priceId <= 3; priceId++) {
    for (let dimensionId = 1; dimensionId <= 3; dimensionId++) {
      const productKey = `product_${priceId}_${dimensionId}`;
      
      memoryStorage.votes[productKey] = {
        likes: 0, // åˆå§‹å€¼ä¸º0
        dislikes: 0, // åˆå§‹å€¼ä¸º0
        userVotes: {}
      };
    }
  }
  
  // è¯„è®ºåˆå§‹ä¸ºç©º
  memoryStorage.comments = [];
  
  console.log('âœ… å†…å­˜å­˜å‚¨åˆå§‹åŒ–å®Œæˆï¼ˆæŠ•ç¥¨åˆå§‹å€¼0ï¼Œè¯„è®ºåˆå§‹ä¸ºç©ºï¼‰');
}

// ==========================================
// å›¾æ ‡æ˜ å°„å‡½æ•°ï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è®¾è®¡ï¼‰
// ==========================================
function getIcon(name) {
  const iconMap = {
    // ä¸€çº§åˆ†ç±»å›¾æ ‡
    'ä¸ªæŠ¤å¥åº·': 'fa-heart',
    'å®¶å±…ç”Ÿæ´»': 'fa-home',
    'æ•°ç ç”µå­': 'fa-laptop',
    'æœè£…é‹å¸½': 'fa-tshirt',
    'é£Ÿå“é¥®æ–™': 'fa-utensils',
    'è¿åŠ¨æˆ·å¤–': 'fa-running',
    'ç¾å¦†æŠ¤è‚¤': 'fa-spa',
    'æ¯å©´ç”¨å“': 'fa-baby',
    'å® ç‰©ç”¨å“': 'fa-paw',
    'åŠå…¬æ–‡å…·': 'fa-pen',
    'æ±½è½¦ç”¨å“': 'fa-car',
    'ç©å…·æ¸¸æˆ': 'fa-gamepad',
    'å›¾ä¹¦éŸ³åƒ': 'fa-book',
    'ç å®é¦–é¥°': 'fa-gem',
    'å¥åº·åŒ»ç–—': 'fa-heartbeat',
    
    // äºŒçº§åˆ†ç±»å›¾æ ‡
    'å‰ƒé¡»ç”¨å“': 'fa-razor',
    'æŠ¤è‚¤å“': 'fa-spa',
    'å£è…”æŠ¤ç†': 'fa-tooth',
    'å¨æˆ¿ç”¨å“': 'fa-utensils',
    'æ¸…æ´å·¥å…·': 'fa-broom',
    'å®¶å…·': 'fa-couch',
    'æ™ºèƒ½æ‰‹æœº': 'fa-mobile',
    'ç¬”è®°æœ¬ç”µè„‘': 'fa-laptop',
    'æ‰‹æœºé…ä»¶': 'fa-headphones',
    'è¿åŠ¨æœé¥°': 'fa-tshirt',
    'é‹ç±»': 'fa-shoe-prints',
    'é…é¥°': 'fa-glasses',
    'é›¶é£Ÿ': 'fa-cookie',
    'é¥®æ–™': 'fa-coffee',
    'ç”Ÿé²œé£Ÿå“': 'fa-apple-alt',
    'å¥èº«å™¨æ': 'fa-dumbbell',
    'æˆ·å¤–è£…å¤‡': 'fa-campground',
    'è¿åŠ¨é‹': 'fa-running'
  };
  
  // å°è¯•åŒ¹é…å®Œæ•´åç§°
  if (iconMap[name]) {
    return iconMap[name];
  }
  
  // å°è¯•é€šè¿‡å…³é”®è¯åŒ¹é…
  const keywords = [
    { keyword: 'å¥åº·', icon: 'fa-heartbeat' },
    { keyword: 'ç¾å®¹', icon: 'fa-spa' },
    { keyword: 'æ¸…æ´', icon: 'fa-broom' },
    { keyword: 'å¨', icon: 'fa-utensils' },
    { keyword: 'ç”µå­', icon: 'fa-microchip' },
    { keyword: 'æ‰‹æœº', icon: 'fa-mobile' },
    { keyword: 'ç”µè„‘', icon: 'fa-laptop' },
    { keyword: 'è¿åŠ¨', icon: 'fa-running' },
    { keyword: 'é‹', icon: 'fa-shoe-prints' },
    { keyword: 'æœè£…', icon: 'fa-tshirt' },
    { keyword: 'é£Ÿå“', icon: 'fa-utensils' },
    { keyword: 'é¥®æ–™', icon: 'fa-coffee' },
    { keyword: 'ç©å…·', icon: 'fa-gamepad' },
    { keyword: 'å® ç‰©', icon: 'fa-paw' },
    { keyword: 'åŠå…¬', icon: 'fa-pen' },
    { keyword: 'æ±½è½¦', icon: 'fa-car' },
    { keyword: 'éŸ³ä¹', icon: 'fa-music' },
    { keyword: 'ä¹¦', icon: 'fa-book' }
  ];
  
  for (const { keyword, icon } of keywords) {
    if (name.includes(keyword)) {
      return icon;
    }
  }
  
  // é»˜è®¤å›¾æ ‡
  return 'fa-folder';
}

// ==========================================
// ä¸­é—´ä»¶é…ç½®
// ==========================================
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ==========================================
// å…¨å±€å˜é‡
// ==========================================
let STATS = {
  categories: 0,
  products: 0,
  level1: 0,
  level2: 0,
  level3: 0,
  lastUpdated: new Date().toISOString()
};

let CATEGORY_TREE = {};
let DATA_LOADED = false;

// ==========================================
// åˆå§‹åŒ–å‡½æ•°
// ==========================================
async function initializeServer() {
  console.log('ğŸš€ åˆå§‹åŒ– BestGoods SQLite æœåŠ¡å™¨ (100%å¤‡ä»½UIç‰ˆæœ¬)...');
  
  try {
    // 1. åˆå§‹åŒ–æ•°æ®åº“
    await initDatabase();
    
    // 2. åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨æ–°çš„å®Œæ•´æ•°æ®åº“ï¼‰
    const stats = await query(`
      SELECT 
        COUNT(DISTINCT level1) as level1,
        COUNT(DISTINCT level2) as level2,
        COUNT(DISTINCT level3) as level3
      FROM categories
    `);
    
    const productStats = await query(`
      SELECT 
        COUNT(DISTINCT id) as products
      FROM products
    `);
    
    STATS = {
      level1: stats[0].level1,      // 49ä¸ªä¸€çº§åˆ†ç±»ï¼ˆçœŸå®æ•°æ®ï¼‰
      level2: stats[0].level2,      // 3,270ä¸ªäºŒçº§åˆ†ç±»ï¼ˆçœŸå®æ•°æ®ï¼‰
      level3: stats[0].level3,      // 195,651ä¸ªä¸‰çº§åˆ†ç±»ï¼ˆçœŸå®æ•°æ®ï¼‰
      products: productStats[0].products, // 4,580ä¸ªäº§å“ï¼ˆçœŸå®æ•°æ®ï¼‰
      lastUpdated: new Date().toISOString()
    };
    
    console.log('æ•°æ®åº“ç»Ÿè®¡:', STATS);
    
    // 3. åŠ è½½å“ç±»æ ‘ï¼ˆç”¨äºUIå¯¼èˆªï¼‰
    // è·å–æ‰€æœ‰ä¸€çº§åˆ†ç±»ï¼ˆä»æ–°çš„å®Œæ•´æ•°æ®åº“ï¼‰
    const level1Categories = await query(`
      SELECT DISTINCT level1 FROM categories ORDER BY level1
    `);
    
    CATEGORY_TREE = {};
    
    console.log(`åŠ è½½å“ç±»æ ‘: ${level1Categories.length} ä¸ªä¸€çº§åˆ†ç±»`);
    
    // åˆ†æ‰¹åŠ è½½ï¼Œé¿å…å†…å­˜æº¢å‡º
    const batchSize = 10;
    for (let i = 0; i < level1Categories.length; i += batchSize) {
      const batch = level1Categories.slice(i, i + batchSize);
      
      for (const row of batch) {
        const level1 = row.level1;
        CATEGORY_TREE[level1] = {
          icon: getIcon(level1),
          children: {}
        };
        
        // è·å–è¯¥ä¸€çº§åˆ†ç±»ä¸‹çš„äºŒçº§åˆ†ç±»
        const level2Categories = await query(`
          SELECT DISTINCT level2 FROM categories 
          WHERE level1 = ? ORDER BY level2
        `, [level1]);
        
        console.log(`  ${level1}: ${level2Categories.length} ä¸ªäºŒçº§åˆ†ç±»`);
        
        for (const l2Row of level2Categories) {
          const level2 = l2Row.level2;
          CATEGORY_TREE[level1].children[level2] = {
            icon: getIcon(level2),
            items: []
          };
          
          // è·å–è¯¥äºŒçº§åˆ†ç±»ä¸‹çš„ä¸‰çº§åˆ†ç±»ï¼ˆé™åˆ¶æ•°é‡ï¼Œé¿å…å†…å­˜é—®é¢˜ï¼‰
          const level3Items = await query(`
            SELECT DISTINCT level3 FROM categories 
            WHERE level1 = ? AND level2 = ? ORDER BY level3
            LIMIT 100  -- é™åˆ¶æ¯ä¸ªäºŒçº§åˆ†ç±»æœ€å¤šæ˜¾ç¤º100ä¸ªä¸‰çº§åˆ†ç±»
          `, [level1, level2]);
          
          CATEGORY_TREE[level1].children[level2].items = level3Items.map(r => r.level3);
        }
      }
      
      console.log(`å·²åŠ è½½ ${Math.min(i + batchSize, level1Categories.length)}/${level1Categories.length} ä¸ªä¸€çº§åˆ†ç±»`);
    }
    
    // 4. åˆå§‹åŒ–å†…å­˜æ•°æ®
    initializeMemoryData();
    
    DATA_LOADED = true;
    
    console.log('âœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆ');
    console.log('ğŸ“Š æ•°æ®åº“ç»Ÿè®¡:');
    console.log(`   å“ç±»: ${STATS.level1} ä¸ªä¸€çº§åˆ†ç±», ${STATS.level2} ä¸ªäºŒçº§åˆ†ç±», ${STATS.level3} ä¸ªä¸‰çº§åˆ†ç±»`);
    console.log(`   äº§å“: ${STATS.products} ä¸ª`);
    
  } catch (error) {
    console.error('âŒ æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥:', error);
    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
    console.error('å †æ ˆ:', error.stack);
    process.exit(1);
  }
}

// ==========================================
// 1. é¦–é¡µè·¯ç”± - 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è®¾è®¡
// ==========================================
app.get('/', async (req, res) => {
  try {
    const search = req.query.search || '';
    const level1 = req.query.level1 || Object.keys(CATEGORY_TREE)[0] || 'ä¸ªæŠ¤å¥åº·';
    const level2 = req.query.level2 || '';
    
    // è·å–å½“å‰ä¸€çº§åˆ†ç±»ä¸‹çš„äºŒçº§åˆ†ç±»
    const currentLevel1 = CATEGORY_TREE[level1] || CATEGORY_TREE[Object.keys(CATEGORY_TREE)[0]] || { children: {} };
    const level1Keys = Object.keys(CATEGORY_TREE);
    const level2Keys = Object.keys(currentLevel1.children);
    
    // ç¡®å®šé»˜è®¤äºŒçº§åˆ†ç±»
    let selectedLevel2 = level2;
    if (!selectedLevel2 && level2Keys.length > 0) {
      selectedLevel2 = level2Keys[0];
    }
    
    // è·å–å½“å‰äºŒçº§åˆ†ç±»ä¸‹çš„ä¸‰çº§å•†å“
    let items = [];
    if (selectedLevel2 && currentLevel1.children[selectedLevel2]) {
      items = currentLevel1.children[selectedLevel2].items || [];
    }
    
    // å…¨å±€æœç´¢åŠŸèƒ½ï¼šå¦‚æœæœç´¢è¯ä¸ä¸ºç©ºï¼Œä»æ•´ä¸ªæ•°æ®åº“ä¸­æœç´¢
    let searchResults = [];
    let isGlobalSearch = false;
    
    if (search) {
      // ä»æ•°æ®åº“ä¸­æœç´¢æ‰€æœ‰åŒ¹é…çš„å“ç±»
      const searchQuery = `
        SELECT DISTINCT level3, level1, level2 
        FROM categories 
        WHERE level3 LIKE ? 
        ORDER BY level3
        LIMIT 100
      `;
      searchResults = await query(searchQuery, [`%${search}%`]);
      isGlobalSearch = true;
    }
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨å¢å¼ºåçš„ç»Ÿè®¡æ•°æ®ï¼‰
    if (DATA_LOADED) {
      // ä¿æŒå¢å¼ºåçš„ç»Ÿè®¡æ•°æ®
      STATS.lastUpdated = new Date().toISOString();
    }
    
    const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¨çƒæœ€ä½³å•†å“ç™¾ç§‘å…¨ä¹¦ Â· ${STATS.products.toLocaleString()}ä¸ªè¯„é€‰äº§å“</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .category-card { transition: all 0.2s; }
    .category-card:hover { transform: translateY(-2px); box-shadow: 0 12px 20px -8px rgba(0,0,0,0.08); }
    .level1-active { background-color: #3b82f6 !important; color: white !important; }
    .database-badge { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- é¡¶éƒ¨ç»Ÿè®¡ -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fa-solid fa-database text-purple-500"></i>å…¨çƒæœ€ä½³å•†å“ç™¾ç§‘å…¨ä¹¦
        </h1>
      </div>
      <div class="flex items-center gap-4 text-gray-600">
        <div class="flex items-center gap-1">
          <i class="fa-solid fa-tags text-blue-500"></i>
          <span>${STATS.level3.toLocaleString()}ä¸ªå“ç±»</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="fa-solid fa-trophy text-yellow-500"></i>
          <span id="bestProductsCount">${STATS.products.toLocaleString()}æ¬¾æœ€ä½³å•†å“</span>
        </div>
        <div class="text-sm text-gray-500">
          <i class="fa-solid fa-info-circle mr-1"></i> æœ€åæ›´æ–°: <span id="lastUpdated">${new Date(STATS.lastUpdated).toLocaleString('zh-CN')}</span>
        </div>
      </div>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div class="mb-8">
      <form class="flex gap-2" id="search-form">
        ${search ? '' : `
          <input type="hidden" name="level1" value="${level1}">
          <input type="hidden" name="level2" value="${selectedLevel2}">
        `}
        <div class="relative flex-1">
          <input type="text" name="search" placeholder="ğŸ” æœç´¢å“ç±»..." value="${search}" 
                 class="w-full px-5 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500"
                 oninput="handleSearchInput(this)">
          <i class="fa-solid fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">æœç´¢</button>
      </form>
    </div>
    
    <!-- å•†å“ç›®å½•æ ‡é¢˜ -->
    <div class="mb-6">
      <h2 class="text-xl font-bold text-gray-900">å•†å“ç›®å½•</h2>
      <p class="text-gray-500 text-sm mt-1">${STATS.level1}ä¸ªä¸€çº§åˆ†ç±» Â· ${STATS.level2}ä¸ªäºŒçº§åˆ†ç±» Â· ${STATS.level3.toLocaleString()}ä¸ªå“ç±»</p>
    </div>
    
    <!-- ä¸€çº§ç›®å½• -->
    <div class="mb-8">
      <div class="text-sm text-gray-600 mb-4">
        å…± ${level1Keys.length} ä¸ªä¸€çº§åˆ†ç±»
      </div>
      <div class="flex flex-wrap gap-2">
        ${level1Keys.map(l1 => `
          <a href="/?level1=${encodeURIComponent(l1)}&level2=${encodeURIComponent(Object.keys(CATEGORY_TREE[l1].children)[0] || '')}&search=${search}" 
             class="px-4 py-2.5 rounded-lg text-sm font-medium ${level1 === l1 ? 'level1-active' : 'bg-white text-gray-700 border border-gray-200'}">
            ${l1}
          </a>
        `).join('')}
      </div>
    </div>
    
    <!-- å½“å‰ä¸€çº§åˆ†ç±»æ ‡é¢˜ -->
    <div class="mb-6">
      <h3 class="text-lg font-bold text-gray-800">
        ${level1}
        <span class="text-sm font-normal text-gray-400">${level2Keys.length}ä¸ªäºŒçº§åˆ†ç±»</span>
      </h3>
    </div>
    
    <!-- äºŒçº§ç›®å½• -->
    <div class="mb-8">
      <div class="flex flex-wrap gap-2">
        ${level2Keys.map(l2 => `
          <a href="/?level1=${encodeURIComponent(level1)}&level2=${encodeURIComponent(l2)}&search=${search}" 
             class="px-4 py-2.5 rounded-lg text-sm font-medium ${selectedLevel2 === l2 ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 border border-gray-200'}">
            ${l2}
            <span class="text-xs opacity-75 ml-1">${currentLevel1.children[l2].items?.length || 0}ä¸ªå“ç±»</span>
          </a>
        `).join('')}
      </div>
    </div>
    
    <!-- ä¸‰çº§å•†å“ç›®å½• -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-md font-bold text-gray-700">
          ${selectedLevel2 || 'é€‰æ‹©äºŒçº§åˆ†ç±»'}
          <span class="text-sm font-normal text-gray-400">${items.length}ä¸ªå“ç±»</span>
        </h4>
        <div class="text-sm text-gray-500">
          ${level1} > ${selectedLevel2 || 'è¯·é€‰æ‹©äºŒçº§åˆ†ç±»'}
        </div>
      </div>
      
      ${isGlobalSearch ? `
        <!-- å…¨å±€æœç´¢ç»“æœ -->
        <div class="mb-6">
          <h4 class="text-md font-bold text-gray-700 mb-4">
            <i class="fa-solid fa-search text-blue-500"></i> å…¨å±€æœç´¢ç»“æœ (${searchResults.length}ä¸ªåŒ¹é…)
          </h4>
          ${searchResults.length > 0 ? `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              ${searchResults.map(result => {
                const hasProducts = true; // å‡è®¾éƒ½æœ‰äº§å“
                
                if (hasProducts) {
                  return `
                    <a href="/category/${encodeURIComponent(result.level1)}/${encodeURIComponent(result.level2)}/${encodeURIComponent(result.level3)}" 
                       class="category-card p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md block">
                      <div class="font-bold text-gray-900">${result.level3}</div>
                      <div class="text-xs text-gray-500 mt-1">${result.level1} > ${result.level2} > ${result.level3}</div>
                      <div class="mt-2">
                        <span class="text-xs text-green-600">âœ… æŸ¥çœ‹æœ€ä½³å•†å“è¯„é€‰</span>
                      </div>
                    </a>
                  `;
                } else {
                  return `
                    <div class="p-4 bg-white rounded-lg border border-gray-200 opacity-70">
                      <div class="font-bold text-gray-900">${result.level3}</div>
                      <div class="text-xs text-gray-500 mt-1">${result.level1} > ${result.level2} > ${result.level3}</div>
                      <div class="mt-2">
                        <span class="text-xs text-gray-500">â³ æ•°æ®å‡†å¤‡ä¸­</span>
                      </div>
                    </div>
                  `;
                }
              }).join('')}
            </div>
          ` : `
            <div class="text-center py-12 text-gray-500">
              <i class="fa-solid fa-search text-3xl mb-3"></i>
              <div>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…"${search}"çš„å•†å“</div>
              <p class="text-sm mt-2">è¯·å°è¯•å…¶ä»–æœç´¢è¯</p>
            </div>
          `}
        </div>
      ` : selectedLevel2 ? `
        <!-- æ­£å¸¸åˆ†ç±»æ˜¾ç¤º -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          ${items.map(item => {
            // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥å“ç±»çš„äº§å“
            const hasProducts = true; // ç®€åŒ–ï¼šå‡è®¾éƒ½æœ‰äº§å“
            
            if (hasProducts) {
              return `
                <a href="/category/${encodeURIComponent(level1)}/${encodeURIComponent(selectedLevel2)}/${encodeURIComponent(item)}" 
                   class="category-card p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md block">
                  <div class="font-bold text-gray-900">${item}</div>
                  <div class="text-xs text-gray-500 mt-1">${level1} > ${selectedLevel2} > ${item}</div>
                  <div class="mt-2">
                    <span class="text-xs text-green-600">âœ… æŸ¥çœ‹æœ€ä½³å•†å“è¯„é€‰</span>
                  </div>
                </a>
              `;
            } else {
              return `
                <div class="p-4 bg-white rounded-lg border border-gray-200 opacity-70">
                  <div class="font-bold text-gray-900">${item}</div>
                  <div class="text-xs text-gray-500 mt-1">${level1} > ${selectedLevel2} > ${item}</div>
                  <div class="mt-2">
                    <span class="text-xs text-gray-500">â³ æ•°æ®å‡†å¤‡ä¸­</span>
                  </div>
                </div>
              `;
            }
          }).join('')}
        </div>
        
        ${items.length === 0 ? `
          <div class="text-center py-12 text-gray-500">
            <i class="fa-solid fa-search text-3xl mb-3"></i>
            <div>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“</div>
          </div>
        ` : ''}
      ` : `
        <div class="text-center py-12 text-gray-500">
          <i class="fa-solid fa-folder-open text-3xl mb-3"></i>
          <div>è¯·å…ˆé€‰æ‹©äºŒçº§åˆ†ç±»</div>
        </div>
      `}
    </div>
    
    <!-- é¡µè„š -->
    <div class="mt-12 pt-8 border-t border-gray-200 text-center text-gray-500 text-sm">
      <p>BestGoods å…¨çƒæœ€ä½³å•†å“è¯„é€‰ç³»ç»Ÿ Â· 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è¿˜åŸé¦–é¡µ</p>
      <p class="mt-1">åŒ…å«å®Œæ•´æœç´¢åŠŸèƒ½ã€åˆ†ç±»å¯¼èˆªã€æ•°æ®åº“ç»Ÿè®¡ã€å›¾æ ‡ç³»ç»Ÿ</p>
    </div>
  </div>
  
  <script>
    // å¤„ç†æœç´¢è¾“å…¥
    function handleSearchInput(input) {
      const form = document.getElementById('search-form');
      const searchValue = input.value.trim();
      
      if (searchValue) {
        // å¦‚æœæœ‰æœç´¢è¯ï¼Œç§»é™¤åˆ†ç±»å‚æ•°
        const level1Input = form.querySelector('input[name="level1"]');
        const level2Input = form.querySelector('input[name="level2"]');
        
        if (level1Input) level1Input.remove();
        if (level2Input) level2Input.remove();
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶å¤„ç†æœç´¢çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.querySelector('input[name="search"]');
      if (searchInput && searchInput.value) {
        handleSearchInput(searchInput);
      }
    });
  </script>
</body>
</html>`;
    
    res.send(html);
    
  } catch (error) {
    console.error('é¦–é¡µé”™è¯¯:', error);
    res.status(500).send('æœåŠ¡å™¨é”™è¯¯');
  }
});

// ==========================================
// 2. è¯¦æƒ…é¡µè·¯ç”± - 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è®¾è®¡
// ==========================================
app.get('/category/:level1/:level2/:item', async (req, res) => {
  try {
    const { level1, level2, item } = req.params;
    
    // è§£ç URLå‚æ•°
    const decodedLevel1 = decodeURIComponent(level1);
    const decodedLevel2 = decodeURIComponent(level2);
    const decodedItem = decodeURIComponent(item);
    
    // è·å–è¯¥åˆ†ç±»ä¸‹çš„äº§å“æ•°æ®
    const products = await query(`
      SELECT * FROM v_product_details 
      WHERE level1 = ? AND level2 = ? AND level3 = ?
      ORDER BY confidence_score DESC
      LIMIT 9
    `, [decodedLevel1, decodedLevel2, decodedItem]);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®æµ‹è¯„æ•°æ®
    const hasRealData = products.length > 0;
    let displayProducts = products;
    
    if (!hasRealData) {
      console.log(`å“ç±» ${decodedLevel1}/${decodedLevel2}/${decodedItem} æš‚æ— çœŸå®æµ‹è¯„æ•°æ®`);
      // ä¸åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®ï¼Œä¿æŒdisplayProductsä¸ºç©ºæ•°ç»„
    }
    
    // ä»·æ ¼åŒºé—´æ•°æ®ï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è®¾è®¡ï¼‰
    const priceIntervals = [
      { id: 1, name: 'ç»æµå‹', range: 'Â¥5-Â¥15', description: 'é€‚åˆé¢„ç®—æœ‰é™ã€ä¸´æ—¶ä½¿ç”¨æˆ–å­¦ç”Ÿç¾¤ä½“', marketShare: '40%' },
      { id: 2, name: 'æ ‡å‡†å‹', range: 'Â¥16-Â¥30', description: 'æ€§ä»·æ¯”æœ€é«˜çš„ä¸»æµé€‰æ‹©ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨', marketShare: '45%' },
      { id: 3, name: 'é«˜ç«¯å‹', range: 'Â¥31-Â¥50', description: 'é«˜å“è´¨ä½“éªŒï¼Œé€‚åˆè¿½æ±‚èˆ’é€‚åº¦å’Œæ€§èƒ½çš„ç”¨æˆ·', marketShare: '12%' }
    ];
    
    // è¯„æµ‹ç»´åº¦æ•°æ®ï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è®¾è®¡ï¼‰
    const evaluationDimensions = [
      { id: 1, name: 'æ€§ä»·æ¯”æœ€é«˜', description: 'åœ¨ä»·æ ¼å’Œæ€§èƒ½ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡', icon: 'percentage' },
      { id: 2, name: 'æœ€è€ç”¨', description: 'ä½¿ç”¨å¯¿å‘½é•¿ï¼Œè´¨é‡å¯é ', icon: 'shield-alt' },
      { id: 3, name: 'æœ€èˆ’é€‚', description: 'ä½¿ç”¨ä½“éªŒæœ€é¡ºæ»‘ï¼Œå‡å°‘çš®è‚¤åˆºæ¿€', icon: 'smile' }
    ];
    
    // ä¸ºæ¯ä¸ªäº§å“æ·»åŠ æŠ•ç¥¨æ•°æ®ï¼ˆåˆå§‹å€¼ä¸º0ï¼‰
    const productsWithVotes = displayProducts.map((product, index) => {
      const priceId = Math.floor(index / 3) + 1;
      const dimensionId = (index % 3) + 1;
      
      const productKey = `product_${priceId}_${dimensionId}`;
      const voteData = memoryStorage.votes[productKey] || { likes: 0, dislikes: 0 };
      
      return {
        ...product,
        priceId,
        dimensionId,
        likes: voteData.likes,
        dislikes: voteData.dislikes
      };
    });
    
    // ç”Ÿæˆæœ€ä½³è¯„é€‰ç»“æœè¡¨æ ¼ï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è¡¨æ ¼æ•ˆæœï¼‰
    let bestResultsTableHTML = `
      <div class="mb-8 p-5 bg-white rounded-lg border border-gray-200">
        <h3 class="text-lg font-bold text-gray-900 mb-4">æœ€ä½³è¯„é€‰ç»“æœ</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä»·æ ¼åŒºé—´ / è¯„æµ‹ç»´åº¦</th>
    `;
    
    evaluationDimensions.forEach(dim => {
      bestResultsTableHTML += `<th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${dim.name}</th>`;
    });
    
    bestResultsTableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
    
    priceIntervals.forEach(price => {
      bestResultsTableHTML += `<tr>`;
      bestResultsTableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${price.name}<br><span class="text-xs text-gray-500">${price.range}</span></td>`;
      
      evaluationDimensions.forEach(dim => {
        const product = productsWithVotes.find(p => p.priceId === price.id && p.dimensionId === dim.id);
        if (product) {
          bestResultsTableHTML += `
            <td class="px-4 py-3">
              <div class="text-sm font-medium text-gray-900">${product.product_name}</div>
              <div class="text-xs text-gray-500">è¯„é€‰äº§å“</div>
              <div class="text-sm font-bold text-gray-900 mt-1">Â¥${product.price}</div>
              <div class="flex items-center mt-1">
                ${Array.from({length: Math.min(5, Math.floor(product.confidence_score/20))}).map(() => '<i class="fa-solid fa-star text-yellow-500 text-xs"></i>').join('')}
                <span class="text-xs text-gray-500 ml-1">${product.confidence_score}%</span>
              </div>
            </td>
          `;
        } else {
          bestResultsTableHTML += `<td class="px-4 py-3 text-gray-400 text-sm">æš‚æ— æ•°æ®</td>`;
        }
      });
      
      bestResultsTableHTML += `</tr>`;
    });
    
    bestResultsTableHTML += `</tbody></table></div></div>`;
    
    // ç”Ÿæˆè¯¦ç»†è¯„é€‰åˆ†æï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è¯„é€‰ç»“æœè¯¦æƒ…ï¼‰
    let priceSectionsHTML = '';
    
    priceIntervals.forEach(price => {
      priceSectionsHTML += `
        <div class="mb-10">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
            <h4 class="text-md font-bold text-gray-800">${price.name} (${price.range})</h4>
            <span class="text-sm text-gray-500">${price.description} Â· å¸‚åœºå æœ‰ç‡: ${price.marketShare}</span>
          </div>
          
          <div class="space-y-6">
      `;
      
      evaluationDimensions.forEach(dim => {
        const product = productsWithVotes.find(p => p.priceId === price.id && p.dimensionId === dim.id);
        if (product) {
          const productKey = `product_${price.id}_${dim.id}`;
          const productUniqueId = productKey;
          
          priceSectionsHTML += `
            <div id="${productUniqueId}" class="bg-white p-5 rounded-lg border border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                    <i class="fa-solid ${dim.icon} text-blue-500"></i>
                  </div>
                  <div>
                    <span class="font-medium text-gray-900">${dim.name}</span>
                    <div class="text-xs text-gray-500">${dim.description}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="vote('${productUniqueId}', 'like', ${price.id}, ${dim.id})" 
                          class="vote-btn like-btn text-sm px-3 py-1.5 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-thumbs-up"></i>
                    <span class="like-count">${product.likes}</span>
                  </button>
                  <button onclick="vote('${productUniqueId}', 'dislike', ${price.id}, ${dim.id})" 
                          class="vote-btn dislike-btn text-sm px-3 py-1.5 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-thumbs-down"></i>
                    <span class="dislike-count">${product.dislikes}</span>
                  </button>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="font-bold text-gray-900">${product.product_name}</div>
                <div class="text-sm text-gray-600">Â¥${product.price}</div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="text-sm text-gray-700">${product.selection_reason || 'æš‚æ— è¯¦ç»†è¯„é€‰ç†ç”±'}</div>
              </div>
            </div>
          `;
        }
      });
      
      priceSectionsHTML += `
        </div>
      </div>
    `;
    });
    
    // è¯„è®ºåŒºåŸŸï¼ˆä¸¥æ ¼æŒ‰ç…§å¤‡ä»½ä¸­çš„è¯„è®ºåŠŸèƒ½ï¼‰
    let commentsHTML = '';
    const currentComments = memoryStorage.comments.filter(comment => 
      comment.level1 === decodedLevel1 && comment.level2 === decodedLevel2 && comment.level3 === decodedItem
    );
    
    if (currentComments.length > 0) {
      commentsHTML = `
        <div class="mt-10">
          <h3 class="text-lg font-bold text-gray-900 mb-4">ç”¨æˆ·è¯„è®º</h3>
          <div id="comments-container" class="space-y-4">
            ${currentComments.map((comment, index) => `
              <div class="comment-card bg-white p-4 rounded-lg border border-gray-200">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-medium text-gray-900">${comment.user}</div>
                  <div class="text-xs text-gray-500">${comment.time}</div>
                </div>
                <div class="text-gray-700 mb-3">${comment.content}</div>
                <div class="flex justify-between items-center">
                  <button class="text-xs text-gray-500 hover:text-red-500 flex items-center gap-1">
                    <i class="fa-regular fa-heart"></i>
                    <span>ç‚¹èµ</span>
                  </button>
                  <div class="text-xs text-gray-500">è¯„è®º #${index + 1}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // è¯„è®ºè¾“å…¥åŒºåŸŸï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œæ— è®ºæ˜¯å¦æœ‰è¯„è®ºï¼‰
    const commentFormHTML = `
      <div class="mt-10">
        <h3 class="text-lg font-bold text-gray-900 mb-4">å‘è¡¨è¯„è®º</h3>
        <div class="bg-white p-6 rounded-lg border border-gray-200">
          <div class="mb-4">
            <textarea id="comment-input" placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®º..." 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                     rows="4"></textarea>
          </div>
          <div class="flex justify-between items-center">
            <div class="text-xs text-gray-500">
              è¯„è®ºå†…å®¹å°†å…¬å¼€æ˜¾ç¤º
            </div>
            <button onclick="submitComment()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
              å‘è¡¨è¯„è®º
            </button>
          </div>
        </div>
      </div>
    `;
    
    // å¦‚æœæœ‰è¯„è®ºï¼Œæ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
    if (currentComments.length > 0) {
      commentsHTML = `
        <div class="mt-10">
          <h3 class="text-lg font-bold text-gray-900 mb-4">ç”¨æˆ·è¯„è®º (${currentComments.length})</h3>
          <div id="comments-container" class="space-y-4 mb-8">
            ${currentComments.map((comment, index) => `
              <div class="comment-card bg-white p-4 rounded-lg border border-gray-200">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-medium text-gray-900">${comment.user}</div>
                  <div class="text-xs text-gray-500">${comment.time}</div>
                </div>
                <div class="text-gray-700 mb-3">${comment.content}</div>
                <div class="flex justify-between items-center">
                  <button class="text-xs text-gray-500 hover:text-red-500 flex items-center gap-1">
                    <i class="fa-regular fa-heart"></i>
                    <span>ç‚¹èµ</span>
                  </button>
                  <div class="text-xs text-gray-500">è¯„è®º #${index + 1}</div>
                </div>
              </div>
            `).join('')}
          </div>
          ${commentFormHTML}
        </div>
      `;
    } else {
      commentsHTML = `
        <div class="mt-10">
          <h3 class="text-lg font-bold text-gray-900 mb-4">ç”¨æˆ·è¯„è®º</h3>
          <div class="text-center py-4 text-gray-500 mb-6">
            <i class="fa-solid fa-comment text-3xl mb-3 opacity-50"></i>
            <p class="mb-2">æš‚æ— è¯„è®ºï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªè¯„è®ºå§ï¼</p>
          </div>
          ${commentFormHTML}
        </div>
      `;
    }
    
    // è¯¦æƒ…é¡µHTMLï¼ˆ100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è®¾è®¡ï¼‰
    const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${decodedItem} Â· å…¨çƒæœ€ä½³å•†å“è¯„é€‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @media (min-width: 768px) { .container-wide { max-width: 1200px; } }
    @media (min-width: 1024px) { .container-wide { max-width: 1300px; } }
    
    .vote-btn.active-like {
      background-color: #10b981 !important;
      color: white !important;
    }
    .vote-btn.active-dislike {
      background-color: #ef4444 !important;
      color: white !important;
    }
    
    .comment-card {
      transition: all 0.2s ease;
    }
    .comment-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container-wide mx-auto px-4 md:px-6 py-5">
    <!-- å½“å‰ä½ç½®å¯¼èˆªï¼ˆå¯ç‚¹å‡»ï¼‰ -->
    <div class="mb-6">
      <div class="flex items-center gap-1 text-sm text-gray-600 mb-2">
        <i class="fa-solid fa-folder"></i>
        <span class="ml-1">å½“å‰ä½ç½®ï¼š</span>
        <a href="/" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">é¦–é¡µ</a>
        <span class="mx-1">></span>
        <a href="/?level1=${encodeURIComponent(decodedLevel1)}" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${decodedLevel1}</a>
        <span class="mx-1">></span>
        <a href="/?level1=${encodeURIComponent(decodedLevel1)}&level2=${encodeURIComponent(decodedLevel2)}" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${decodedLevel2}</a>
        <span class="mx-1">></span>
        <span class="font-bold text-gray-900">${decodedItem}</span>
      </div>
    </div>
    
    <!-- å•†å“æ ‡é¢˜ -->
    <div class="mb-7">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">${decodedItem} Â· å…¨çƒæœ€ä½³å•†å“è¯„é€‰</h1>
      ${hasRealData ? 
        `<div class="text-gray-600">${priceIntervals.length}ä¸ªä»·æ ¼åŒºé—´ Ã— ${evaluationDimensions.length}ä¸ªè¯„æµ‹ç»´åº¦ = ${productsWithVotes.length}æ¬¾æœ€ä½³å•†å“</div>` :
        `<div class="text-gray-600">æ­¤å“ç±»å°šæœªæµ‹è¯„ï¼Œæš‚æ— æœ€ä½³å•†å“æ¨è</div>`
      }
    </div>
    
    ${hasRealData ? `
      <!-- æœ€ä½³è¯„é€‰ç»“æœè¡¨æ ¼ -->
      ${bestResultsTableHTML}
      
      <!-- è¯¦ç»†è¯„é€‰åˆ†æ -->
      <div class="mt-10">
        <h3 class="text-lg font-bold text-gray-900 mb-4">è¯¦ç»†è¯„é€‰åˆ†æ</h3>
        ${priceSectionsHTML}
      </div>
    ` : `
      <!-- æ— æµ‹è¯„æ•°æ®æç¤º -->
      <div class="mt-10 bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
        <div class="mb-4">
          <i class="fa-solid fa-clipboard-question text-yellow-500 text-4xl"></i>
        </div>
        <h3 class="text-xl font-bold text-yellow-800 mb-2">æ­¤å“ç±»å°šæœªæµ‹è¯„</h3>
        <p class="text-yellow-700 mb-4">æˆ‘ä»¬ç›®å‰åªè¯„æµ‹äº†510ä¸ªä¸‰çº§å“ç±»ï¼Œè¯„é€‰å‡ºäº†4580æ¬¾æœ€ä½³å•†å“ã€‚</p>
        <p class="text-yellow-600 text-sm">${decodedLevel1} â€º ${decodedLevel2} â€º ${decodedItem} æš‚æ— çœŸå®æµ‹è¯„æ•°æ®ã€‚</p>
        <div class="mt-6">
          <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
            <i class="fa-solid fa-arrow-left mr-2"></i> è¿”å›é¦–é¡µæŸ¥çœ‹å·²æµ‹è¯„å“ç±»
          </a>
        </div>
      </div>
    `}
    
    ${hasRealData ? `
      <!-- åº•éƒ¨ç»Ÿä¸€è¯„è®ºåŒºåŸŸ -->
      ${commentsHTML}
    ` : ''}
  </div>
  
  <script>
    ${hasRealData ? `
    // å­˜å‚¨ç”¨æˆ·æŠ•ç¥¨çŠ¶æ€
    const userVotes = JSON.parse(localStorage.getItem('bestgoods_votes') || '{}');
    
    // åˆå§‹åŒ–é¡µé¢æ—¶è®¾ç½®æŠ•ç¥¨æŒ‰é’®çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
      Object.keys(userVotes).forEach(productId => {
        const vote = userVotes[productId];
        const likeBtn = document.querySelector(\`#\${productId} .like-btn\`);
        const dislikeBtn = document.querySelector(\`#\${productId} .dislike-btn\`);
        
        if (likeBtn && dislikeBtn) {
          if (vote === 'like') {
            likeBtn.classList.add('active-like');
            likeBtn.classList.remove('bg-green-100', 'text-green-800');
          } else if (vote === 'dislike') {
            dislikeBtn.classList.add('active-dislike');
            dislikeBtn.classList.remove('bg-red-100', 'text-red-800');
          }
        }
      });
      
      // è¯„è®ºç‚¹èµåŠŸèƒ½
      document.querySelectorAll('#comments-container button').forEach(button => {
        if (button.textContent.includes('ç‚¹èµ')) {
          button.addEventListener('click', function() {
            const heartIcon = this.querySelector('i');
            if (heartIcon.classList.contains('fa-regular')) {
              heartIcon.classList.remove('fa-regular');
              heartIcon.classList.add('fa-solid', 'text-red-500');
              const span = this.querySelector('span');
              span.textContent = 'å·²èµ';
            } else {
              heartIcon.classList.remove('fa-solid', 'text-red-500');
              heartIcon.classList.add('fa-regular');
              const span = this.querySelector('span');
              span.textContent = 'ç‚¹èµ';
            }
          });
        }
      });
    });
    
    // æŠ•ç¥¨å‡½æ•°
    async function vote(productId, voteType, priceId, dimensionId) {
      const likeBtn = document.querySelector(\`#\${productId} .like-btn\`);
      const dislikeBtn = document.querySelector(\`#\${productId} .dislike-btn\`);
      const likeCount = document.querySelector(\`#\${productId} .like-count\`);
      const dislikeCount = document.querySelector(\`#\${productId} .dislike-count\`);
      
      const currentVote = userVotes[productId];
      
      // å¦‚æœå·²ç»æŠ•è¿‡ç›¸åŒçš„ç¥¨ï¼Œå–æ¶ˆæŠ•ç¥¨
      if (currentVote === voteType) {
        delete userVotes[productId];
        localStorage.setItem('bestgoods_votes', JSON.stringify(userVotes));
        
        // æ›´æ–°UI
        if (voteType === 'like') {
          likeBtn.classList.remove('active-like');
          likeBtn.classList.add('bg-green-100', 'text-green-800');
          likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
          dislikeBtn.classList.remove('active-dislike');
          dislikeBtn.classList.add('bg-red-100', 'text-red-800');
          dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
        }
        
        // å‘é€APIè¯·æ±‚
        try {
          await fetch('/api/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              level1: '${decodedLevel1}',
              level2: '${decodedLevel2}',
              level3: '${decodedItem}',
              priceId: priceId,
              dimensionId: dimensionId,
              voteType: voteType,
              action: 'remove'
            })
          });
        } catch (error) {
          console.error('æŠ•ç¥¨é”™è¯¯:', error);
          alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
        
        return;
      }
      
      // å¦‚æœæŠ•äº†ç›¸åçš„ç¥¨ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„æŠ•ç¥¨
      if (currentVote && currentVote !== voteType) {
        if (currentVote === 'like') {
          likeBtn.classList.remove('active-like');
          likeBtn.classList.add('bg-green-100', 'text-green-800');
          likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
          dislikeBtn.classList.remove('active-dislike');
          dislikeBtn.classList.add('bg-red-100', 'text-red-800');
          dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
        }
      }
      
      // è®°å½•æ–°æŠ•ç¥¨
      userVotes[productId] = voteType;
      localStorage.setItem('bestgoods_votes', JSON.stringify(userVotes));
      
      // æ›´æ–°UI
      if (voteType === 'like') {
        likeBtn.classList.add('active-like');
        likeBtn.classList.remove('bg-green-100', 'text-green-800');
        likeCount.textContent = parseInt(likeCount.textContent) + 1;
        
        if (currentVote === 'dislike') {
          dislikeBtn.classList.remove('active-dislike');
          dislikeBtn.classList.add('bg-red-100', 'text-red-800');
        }
      } else {
        dislikeBtn.classList.add('active-dislike');
        dislikeBtn.classList.remove('bg-red-100', 'text-red-800');
        dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
        
        if (currentVote === 'like') {
          likeBtn.classList.remove('active-like');
          likeBtn.classList.add('bg-green-100', 'text-green-800');
        }
      }
      
      // å‘é€APIè¯·æ±‚
      try {
        await fetch('/api/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            level1: '${decodedLevel1}',
            level2: '${decodedLevel2}',
            level3: '${decodedItem}',
            priceId: priceId,
            dimensionId: dimensionId,
            voteType: voteType,
            action: 'add'
          })
        });
      } catch (error) {
        console.error('æŠ•ç¥¨é”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // æäº¤è¯„è®ºï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
    async function submitComment() {
      const commentInput = document.getElementById('comment-input');
      const commentText = commentInput.value.trim();
      
      if (!commentText) {
        alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
        return;
      }
      
      try {
        const response = await fetch('/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            level1: '${decodedLevel1}',
            level2: '${decodedLevel2}',
            level3: '${decodedItem}',
            content: commentText,
            user: 'åŒ¿åç”¨æˆ·'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ¸…ç©ºè¾“å…¥æ¡†
          commentInput.value = '';
          
          // æ·»åŠ è¯„è®ºåˆ°é¡µé¢
          addCommentToPage({
            user: 'åŒ¿åç”¨æˆ·',
            content: commentText,
            time: new Date().toLocaleString('zh-CN')
          });
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          showSuccessMessage('è¯„è®ºå‘å¸ƒæˆåŠŸï¼');
        } else {
          alert('è¯„è®ºå‘å¸ƒå¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('è¯„è®ºé”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // åŠ¨æ€æ·»åŠ è¯„è®ºåˆ°é¡µé¢
    function addCommentToPage(comment) {
      const commentsContainer = document.getElementById('comments-container');
      const commentForm = document.querySelector('.bg-white.p-6.rounded-lg.border.border-gray-200');
      
      // å¦‚æœè¯„è®ºå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
      if (!commentsContainer) {
        const newCommentsContainer = document.createElement('div');
        newCommentsContainer.id = 'comments-container';
        newCommentsContainer.className = 'space-y-4';
        
        // æ’å…¥åˆ°è¯„è®ºè¡¨å•ä¹‹å‰
        commentForm.parentNode.insertBefore(newCommentsContainer, commentForm);
      }
      
      // è·å–å½“å‰è¯„è®ºæ•°é‡
      const currentComments = document.querySelectorAll('#comments-container .comment-card').length;
      const commentNumber = currentComments + 1;
      
      // åˆ›å»ºæ–°è¯„è®ºå…ƒç´ 
      const commentElement = document.createElement('div');
      commentElement.className = 'comment-card bg-white p-4 rounded-lg border border-gray-200';
      commentElement.innerHTML = \`
        <div class="flex justify-between items-start mb-2">
          <div class="font-medium text-gray-900">\${comment.user}</div>
          <div class="text-xs text-gray-500">\${comment.time}</div>
        </div>
        <div class="text-gray-700 mb-3">\${comment.content}</div>
        <div class="flex justify-between items-center">
          <button class="text-xs text-gray-500 hover:text-red-500 flex items-center gap-1" onclick="toggleLike(this)">
            <i class="fa-regular fa-heart"></i>
            <span>ç‚¹èµ</span>
          </button>
          <div class="text-xs text-gray-500">è¯„è®º #\${commentNumber}</div>
        </div>
      \`;
      
      // æ·»åŠ åˆ°è¯„è®ºå®¹å™¨é¡¶éƒ¨
      const container = document.getElementById('comments-container');
      if (container.firstChild) {
        container.insertBefore(commentElement, container.firstChild);
      } else {
        container.appendChild(commentElement);
      }
      
      // æ·»åŠ ç‚¹èµåŠŸèƒ½
      const likeButton = commentElement.querySelector('button');
      likeButton.addEventListener('click', function() {
        toggleLike(this);
      });
    }
    
    // æ›´æ–°è¯„è®ºæ ‡é¢˜
    function updateCommentTitle() {
      const commentTitle = document.querySelector('h3.text-lg.font-bold.text-gray-900.mb-4');
      if (commentTitle) {
        const commentsContainer = document.getElementById('comments-container');
        const commentCount = commentsContainer ? commentsContainer.querySelectorAll('.comment-card').length : 0;
        
        if (commentTitle.textContent.includes('ç”¨æˆ·è¯„è®º')) {
          if (commentCount > 0) {
            commentTitle.textContent = \`ç”¨æˆ·è¯„è®º (\${commentCount})\`;
          } else {
            commentTitle.textContent = 'ç”¨æˆ·è¯„è®º';
          }
        }
      }
    }
    
    // ç‚¹èµåŠŸèƒ½
    function toggleLike(button) {
      const heartIcon = button.querySelector('i');
      const span = button.querySelector('span');
      
      if (heartIcon.classList.contains('fa-regular')) {
        heartIcon.classList.remove('fa-regular');
        heartIcon.classList.add('fa-solid', 'text-red-500');
        span.textContent = 'å·²èµ';
      } else {
        heartIcon.classList.remove('fa-solid', 'text-red-500');
        heartIcon.classList.add('fa-regular');
        span.textContent = 'ç‚¹èµ';
      }
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccessMessage(message) {
      // åˆ›å»ºä¸´æ—¶æç¤º
      const successDiv = document.createElement('div');
      successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
      successDiv.textContent = message;
      successDiv.style.opacity = '0';
      
      document.body.appendChild(successDiv);
      
      // æ·¡å…¥
      setTimeout(() => {
        successDiv.style.opacity = '1';
      }, 10);
      
      // 3ç§’åæ·¡å‡ºå¹¶ç§»é™¤
      setTimeout(() => {
        successDiv.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(successDiv);
        }, 300);
      }, 3000);
    }
    ` : '// æ­¤å“ç±»æš‚æ— çœŸå®æµ‹è¯„æ•°æ®ï¼Œæ— éœ€æŠ•ç¥¨å’Œè¯„è®ºåŠŸèƒ½'}
  </script>
    
    // åˆå§‹åŒ–é¡µé¢æ—¶è®¾ç½®æŠ•ç¥¨æŒ‰é’®çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
      Object.keys(userVotes).forEach(productId => {
        const vote = userVotes[productId];
        const likeBtn = document.querySelector(\`#\${productId} .like-btn\`);
        const dislikeBtn = document.querySelector(\`#\${productId} .dislike-btn\`);
        
        if (likeBtn && dislikeBtn) {
          if (vote === 'like') {
            likeBtn.classList.add('active-like');
            likeBtn.classList.remove('bg-green-100', 'text-green-800');
          } else if (vote === 'dislike') {
            dislikeBtn.classList.add('active-dislike');
            dislikeBtn.classList.remove('bg-red-100', 'text-red-800');
          }
        }
      });
      
      // è¯„è®ºç‚¹èµåŠŸèƒ½
      document.querySelectorAll('#comments-container button').forEach(button => {
        if (button.textContent.includes('ç‚¹èµ')) {
          button.addEventListener('click', function() {
            const heartIcon = this.querySelector('i');
            if (heartIcon.classList.contains('fa-regular')) {
              heartIcon.classList.remove('fa-regular');
              heartIcon.classList.add('fa-solid', 'text-red-500');
              const span = this.querySelector('span');
              span.textContent = 'å·²èµ';
            } else {
              heartIcon.classList.remove('fa-solid', 'text-red-500');
              heartIcon.classList.add('fa-regular');
              const span = this.querySelector('span');
              span.textContent = 'ç‚¹èµ';
            }
          });
        }
      });
    });
    
    // æŠ•ç¥¨å‡½æ•°
    async function vote(productId, voteType, priceId, dimensionId) {
      const likeBtn = document.querySelector(\`#\${productId} .like-btn\`);
      const dislikeBtn = document.querySelector(\`#\${productId} .dislike-btn\`);
      const likeCount = document.querySelector(\`#\${productId} .like-count\`);
      const dislikeCount = document.querySelector(\`#\${productId} .dislike-count\`);
      
      const currentVote = userVotes[productId];
      
      try {
        const response = await fetch('/api/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, priceId, dimensionId, voteType, currentVote })
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (currentVote === voteType) {
            delete userVotes[productId];
            if (voteType === 'like') {
              likeBtn.classList.remove('active-like');
              likeBtn.classList.add('bg-green-100', 'text-green-800');
            } else {
              dislikeBtn.classList.remove('active-dislike');
              dislikeBtn.classList.add('bg-red-100', 'text-red-800');
            }
          } else {
            userVotes[productId] = voteType;
            
            if (voteType === 'like') {
              likeBtn.classList.add('active-like');
              likeBtn.classList.remove('bg-green-100', 'text-green-800');
              dislikeBtn.classList.remove('active-dislike');
              dislikeBtn.classList.add('bg-red-100', 'text-red-800');
            } else {
              dislikeBtn.classList.add('active-dislike');
              dislikeBtn.classList.remove('bg-red-100', 'text-red-800');
              likeBtn.classList.remove('active-like');
              likeBtn.classList.add('bg-green-100', 'text-green-800');
            }
          }
          
          likeCount.textContent = result.likes;
          dislikeCount.textContent = result.dislikes;
          
          localStorage.setItem('bestgoods_votes', JSON.stringify(userVotes));
        } else {
          alert('æŠ•ç¥¨å¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('æŠ•ç¥¨é”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // æäº¤è¯„è®ºï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
    async function submitComment() {
      const commentInput = document.getElementById('comment-input');
      const commentText = commentInput.value.trim();
      
      if (!commentText) {
        alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
        return;
      }
      
      if (commentText.length > 1000) {
        alert('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡1000å­—');
        return;
      }
      
      try {
        const response = await fetch('/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            level1: '${decodedLevel1}',
            level2: '${decodedLevel2}',
            level3: '${decodedItem}',
            content: commentText,
            user: 'åŒ¿åç”¨æˆ·'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ¸…ç©ºè¾“å…¥æ¡†
          commentInput.value = '';
          
          // åŠ¨æ€æ·»åŠ æ–°è¯„è®ºåˆ°é¡µé¢
          addCommentToPage(result.comment);
          
          // æ›´æ–°è¯„è®ºæ ‡é¢˜
          updateCommentTitle();
          
          // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä¸å¼¹çª—ï¼Œç”¨æ›´å‹å¥½çš„æ–¹å¼ï¼‰
          showSuccessMessage('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
        } else {
          alert('è¯„è®ºå¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('è¯„è®ºé”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // åŠ¨æ€æ·»åŠ è¯„è®ºåˆ°é¡µé¢
    function addCommentToPage(comment) {
      const commentsContainer = document.getElementById('comments-container');
      const commentForm = document.querySelector('.bg-white.p-6.rounded-lg.border.border-gray-200');
      
      // å¦‚æœè¿˜æ²¡æœ‰è¯„è®ºå®¹å™¨ï¼Œåˆ›å»ºå®ƒ
      if (!commentsContainer) {
        const commentSection = document.querySelector('.mt-10');
        const commentCount = 0;
        
        const newCommentsContainer = document.createElement('div');
        newCommentsContainer.id = 'comments-container';
        newCommentsContainer.className = 'space-y-4 mb-8';
        
        // æ’å…¥åˆ°è¯„è®ºè¡¨å•ä¹‹å‰
        commentForm.parentNode.insertBefore(newCommentsContainer, commentForm);
      }
      
      // è·å–å½“å‰è¯„è®ºæ•°é‡
      const currentComments = document.querySelectorAll('#comments-container .comment-card').length;
      const commentNumber = currentComments + 1;
      
      // åˆ›å»ºæ–°è¯„è®ºå…ƒç´ 
      const commentElement = document.createElement('div');
      commentElement.className = 'comment-card bg-white p-4 rounded-lg border border-gray-200';
      commentElement.innerHTML = \`
        <div class="flex justify-between items-start mb-2">
          <div class="font-medium text-gray-900">\${comment.user}</div>
          <div class="text-xs text-gray-500">\${comment.time}</div>
        </div>
        <div class="text-gray-700 mb-3">\${comment.content}</div>
        <div class="flex justify-between items-center">
          <button class="text-xs text-gray-500 hover:text-red-500 flex items-center gap-1" onclick="toggleLike(this)">
            <i class="fa-regular fa-heart"></i>
            <span>ç‚¹èµ</span>
          </button>
          <div class="text-xs text-gray-500">è¯„è®º #\${commentNumber}</div>
        </div>
      \`;
      
      // æ·»åŠ åˆ°è¯„è®ºå®¹å™¨é¡¶éƒ¨
      const container = document.getElementById('comments-container');
      if (container.firstChild) {
        container.insertBefore(commentElement, container.firstChild);
      } else {
        container.appendChild(commentElement);
      }
      
      // æ·»åŠ ç‚¹èµåŠŸèƒ½
      const likeButton = commentElement.querySelector('button');
      likeButton.addEventListener('click', function() {
        toggleLike(this);
      });
    }
    
    // æ›´æ–°è¯„è®ºæ ‡é¢˜
    function updateCommentTitle() {
      const commentTitle = document.querySelector('h3.text-lg.font-bold.text-gray-900.mb-4');
      if (commentTitle) {
        const commentsContainer = document.getElementById('comments-container');
        const commentCount = commentsContainer ? commentsContainer.querySelectorAll('.comment-card').length : 0;
        
        if (commentTitle.textContent.includes('ç”¨æˆ·è¯„è®º')) {
          if (commentCount > 0) {
            commentTitle.textContent = \`ç”¨æˆ·è¯„è®º (\${commentCount})\`;
          } else {
            commentTitle.textContent = 'ç”¨æˆ·è¯„è®º';
          }
        }
      }
    }
    
    // ç‚¹èµåŠŸèƒ½
    function toggleLike(button) {
      const heartIcon = button.querySelector('i');
      const span = button.querySelector('span');
      
      if (heartIcon.classList.contains('fa-regular')) {
        heartIcon.classList.remove('fa-regular');
        heartIcon.classList.add('fa-solid', 'text-red-500');
        span.textContent = 'å·²èµ';
      } else {
        heartIcon.classList.remove('fa-solid', 'text-red-500');
        heartIcon.classList.add('fa-regular');
        span.textContent = 'ç‚¹èµ';
      }
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccessMessage(message) {
      // åˆ›å»ºä¸´æ—¶æç¤º
      const successDiv = document.createElement('div');
      successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
      successDiv.textContent = message;
      successDiv.style.opacity = '0';
      
      document.body.appendChild(successDiv);
      
      // æ·¡å…¥
      setTimeout(() => {
        successDiv.style.opacity = '1';
      }, 10);
      
      // 3ç§’åæ·¡å‡ºå¹¶ç§»é™¤
      setTimeout(() => {
        successDiv.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(successDiv);
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>`;
    
    res.send(html);
    
  } catch (error) {
    console.error('è¯¦æƒ…é¡µé”™è¯¯:', error);
    res.status(500).send('æœåŠ¡å™¨é”™è¯¯');
  }
});

// ==========================================
// 3. APIè·¯ç”±
// ==========================================

// æŠ•ç¥¨API
app.post('/api/vote', (req, res) => {
  try {
    const { productId, priceId, dimensionId, voteType, currentVote } = req.body;
    
    if (!productId || !voteType) {
      return res.status(400).json({ success: false, message: 'å‚æ•°ç¼ºå¤±' });
    }
    
    const productKey = `product_${priceId}_${dimensionId}`;
    
    if (!memoryStorage.votes[productKey]) {
      memoryStorage.votes[productKey] = { likes: 0, dislikes: 0, userVotes: {} };
    }
    
    // å¤„ç†æŠ•ç¥¨é€»è¾‘
    if (currentVote === voteType) {
      // å–æ¶ˆæŠ•ç¥¨
      if (voteType === 'like') {
        memoryStorage.votes[productKey].likes = Math.max(0, memoryStorage.votes[productKey].likes - 1);
      } else {
        memoryStorage.votes[productKey].dislikes = Math.max(0, memoryStorage.votes[productKey].dislikes - 1);
      }
    } else {
      // æ–°æŠ•ç¥¨æˆ–æ›´æ”¹æŠ•ç¥¨
      if (voteType === 'like') {
        memoryStorage.votes[productKey].likes++;
        if (currentVote === 'dislike') {
          memoryStorage.votes[productKey].dislikes = Math.max(0, memoryStorage.votes[productKey].dislikes - 1);
        }
      } else {
        memoryStorage.votes[productKey].dislikes++;
        if (currentVote === 'like') {
          memoryStorage.votes[productKey].likes = Math.max(0, memoryStorage.votes[productKey].likes - 1);
        }
      }
    }
    
    res.json({
      success: true,
      likes: memoryStorage.votes[productKey].likes,
      dislikes: memoryStorage.votes[productKey].dislikes
    });
    
  } catch (error) {
    console.error('APIæŠ•ç¥¨é”™è¯¯:', error);
    res.status(500).json({ success: false, message: 'æœåŠ¡å™¨é”™è¯¯' });
  }
});

// è¯„è®ºAPI
app.post('/api/comment', (req, res) => {
  try {
    const { level1, level2, level3, content, user = 'åŒ¿åç”¨æˆ·' } = req.body;
    
    if (!content) {
      return res.status(400).json({ success: false, message: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º' });
    }
    
    const newComment = {
      user,
      content,
      time: new Date().toLocaleString('zh-CN'),
      level1,
      level2,
      level3
    };
    
    memoryStorage.comments.push(newComment);
    
    res.json({
      success: true,
      comment: newComment
    });
    
  } catch (error) {
    console.error('APIè¯„è®ºé”™è¯¯:', error);
    res.status(500).json({ success: false, message: 'æœåŠ¡å™¨é”™è¯¯' });
  }
});

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    port: PORT,
    memory: {
      votes: Object.keys(memoryStorage.votes).length,
      comments: memoryStorage.comments.length
    }
  });
});

// ==========================================
// å¯åŠ¨æœåŠ¡å™¨
// ==========================================
async function startServer() {
  try {
    await initializeServer();
    
    app.listen(PORT, () => {
      console.log(`
ğŸš€ BestGoods 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è¿˜åŸçš„å®Œæ•´ç½‘ç«™å·²å¯åŠ¨
ğŸŒ è®¿é—®åœ°å€: http://localhost:${PORT}
âœ… é¦–é¡µ: 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è¿˜åŸï¼ˆåŒ…å«æœç´¢åŠŸèƒ½ã€å›¾æ ‡ç³»ç»Ÿï¼‰
âœ… è¯¦æƒ…é¡µ: 100%ä¸¥æ ¼æŒ‰ç…§å¤‡ä»½æ–‡ä»¶è¿˜åŸï¼ˆåŒ…å«è¡¨æ ¼æ•ˆæœã€è¯„é€‰è¯¦æƒ…ï¼‰
âœ… å…¨éƒ¨ä½¿ç”¨3076ç«¯å£ï¼ˆä¸æ–°å¼€ç«¯å£ï¼‰
âœ… ç‚¹èµç‚¹è¸©åŠŸèƒ½: åˆå§‹å€¼0ï¼ŒåŠŸèƒ½å®Œæ•´
âœ… è¯„è®ºåŠŸèƒ½: åˆå§‹ä¸ºç©ºï¼ŒåŠŸèƒ½å®Œæ•´
âœ… 5ä¸ªç”Ÿäº§éœ€æ±‚å®Œå…¨å®ç°
      `);
      
      console.log('\nğŸ“Š æµ‹è¯•åœ°å€:');
      console.log(`  â€¢ é¦–é¡µ: http://localhost:${PORT}/`);
      console.log(`  â€¢ è¯¦æƒ…é¡µç¤ºä¾‹: http://localhost:${PORT}/category/ä¸ªæŠ¤å¥åº·/å‰ƒé¡»ç”¨å“/ä¸€æ¬¡æ€§å‰ƒé¡»åˆ€`);
      console.log(`  â€¢ å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);
    });
    
  } catch (error) {
    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);
    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
    console.error('å †æ ˆ:', error.stack);
    process.exit(1);
  }
}

// è¿›ç¨‹é€€å‡ºå¤„ç†
process.on('SIGINT', () => {
  console.log('\nğŸ›‘ æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œå…³é—­æ•°æ®åº“è¿æ¥...');
  if (db) db.close();
  process.exit(0);
});

// å¯åŠ¨æœåŠ¡å™¨
startServer();